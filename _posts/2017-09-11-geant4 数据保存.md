---
layout: post
title:  "gent4 数据保存"
categories: geant4
tags:  geant4 模拟
author: loyxin
mathjax: true
---
* content
{:toc}

## 数据保存
先介绍各个 action 类可以做什么
### action 类
#### runAction
G4UserRunAction
- void BeginOfRunAction(const G4Run*)
- void EndOfRunAction(const G4Run*)
- G4Run* GenerateRun()

Uses:

- Book/output histograms and other analysis tools
- Custom G4Run with additional information
- Define parameters

#### EverntAction
G4UserEventAction
- void BeginOfEventAction(const G4Event*)
- void EndOfEventAction(const G4Event*)

Uses:
- Hit collection and event analysis
- Event selection
- Logging (e.g. output event number)

#### StackingAction
G4UserStackingAction
- G4ClassificationOfNewTrack ClassifyNewTrack(const G4Track*)
- void NewStage()
- void PrepareNewEvent()

Uses:
- Pre-selection of tracks (~manual cuts)
- Optimization of the order of track execution

#### TrackingAction
G4UserTrackingAction
- void PreUserTrackingAction(const G4Track*)
- void PostUserTrackingAction(const G4Track*)

Uses:
- Track pre-selection
- Store trajectories

#### SteppingAction
G4UserSteppingAction
- void UserSteppingAction(const G4Step*)

Uses:
-  Get information about particles
-  Kill tracks under specific circumstances

### Accumulable 保存数据
介绍：通过各个 action 将数据保存到 accumulable 变量中
1. Declare (instance) variables (of RunAction文件中)

```cpp
G4Accumulable<G4int> fNElectrons;
G4Accumulable<G4double> fAverageElectronEnergy;
```

2. Register to accumulable manager (in RunAction constructor)

```cpp
G4AccumulableManager* accManager = G4AccumulableManager::Instance();
accManager->RegisterAccumulable(fNElectrons);
accManager->RegisterAccumulable(fAverageElectronEnergy);
```

3. Reset to zero values (in RunAction::BeginOfRunAction)

```cpp
G4AccumulableManager* accManager = G4AccumulableManager::Instance();
accManager->Reset();
```

4. Update during run (e.g. in Stacking action)

```cpp
fNElectrons += 1; // Normal arithmetics
```

5. Merge after run (in RunAction::EndOfRunAction)

```cpp
G4AccumulableManager* accManager = G4AccumulableManager::Instance();
accManager->Merge();
```

6. Report after run (in RunAction::EndOfRunAction)

```cpp
G4AccumulableManager* accManager = G4AccumulableManager::Instance();
if (IsMaster())
{
if (fNElectrons.GetValue())
{
G4cout << " * Produced " << fNElectrons.GetValue();
G4cout << " secondary electrons/event. Average energy: ";
G4cout << fAverageElectronEnergy.GetValue() / keV / fNElectrons.GetValue();
G4cout << " keV" << G4endl;
}
else
G4cout << " * No secondary electrons produced" << G4endl;
}
```

### 数据输出到外部文件

1. 打开文件和设置文件参数 histograms & Ntuples

```cpp
// histograms
void MyRunAction::BeginOfRunAction(const G4Run* run)
{
// Get analysis manager
G4AnalysisManager* man = G4AnalysisManager::Instance();
man->SetVerboseLevel(1);
man->SetFirstHistoId(1); // 文件开始的 id 为 1 
// Creating histograms
man->CreateH1("h", "Title", 100, 0., 800*MeV);// id =1
man->CreateH1("hh", "Title", 100, 0., 10*MeV);// id =2
// Open an output file
man->OpenFile("myoutput");
}

// Ntuples
void MyRunAction::BeginOfRunAction(const G4Run* run)
{
// Get analysis manager
G4AnalysisManager* man = G4AnalysisManager::Instance();
man-> SetFirstNtupleId(1); // 文件开始的 id 为 1 
// Creating ntuples
man->CreateNtuple("name", "Title"); // id =1
man->CreateNtupleDColumn("Eabs");
man->CreateNtupleDColumn("Egap");
man->FinishNtuple();
man->CreateNtuple("name2","title2"); // id =2
man->CreateNtupleIColumn("ID");
man->FinishNtuple();
}
```

2. 写入数据

```cpp
void MyEventAction::EndOfEventAction(const G4Run* aRun)
{
auto man = G4AnalysisManager::Instance();
man->FillH1(1, fEnergyAbs); // 填写第一个
man->FillH1(2, fEnergyGap); // 填写第二个
}
MyRunAction::~MyRunAction()
{
auto man = G4AnalysisManager::Instance();
man->Write();
}
int main()
{
...
auto man = G4AnalysisManager::Instance();
man->CloseFile();
}

// Ntuples
void MyEventAction::EndOfEventAction(const G4Run* aRun)
{
G4AnalysisManager* man = G4AnalysisManager::Instance();
man->FillNtupleDColumn(1, 0, fEnergyAbs);// id = 1 columns 0,1
man->FillNtupleDColumn(1, 1, fEnergyGap);
man->AddNtupleRow(1);
man->FillNtupleIColumn(2, 0, fID);;// id = 1 columns 0
man->AddNtupleRow(2);
}
MyRunAction::~MyRunAction()
{
auto man = G4AnalysisManager::Instance();
man->Write();
}
int main()
{
...
auto man = G4AnalysisManager::Instance();
man->CloseFile();
}

```