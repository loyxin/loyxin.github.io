---
layout: post
title:  "gent4 敏感探测器"
categories: geant4
tags:  geant4 模拟
author: loyxin
mathjax: true
---
* content
{:toc}

## 敏感探测器

### 注册敏感探测器

在 ConstructSDandField() 函数写
```cpp
G4VSensitiveDetector* mySensitive= new MySensitiveDetector(SDname="/MyDetector"); // 可以是自己定义的敏感探测器也可以是系统自带的多功能探测器
G4SDManager* sdMan =G4SDManager::GetSDMpointer();
sdMan->AddNewDetector(mySensitive);// Register tothe SD manager
SetSensitiveDetector("the name of your logical volume",mySensitive);// assign to logicalvolume
```
也可以用想要变成敏感探测器的 logicalVolume 下注册
```cpp
logicalVolume->SetSensitiveDetector(mySensitive);
```

### 调用系统自带多功能探测器

By using this approach, no need to implement sensitive detector and hit classes!

for example
```cpp
G4MultiFunctionalDetector* myScorer = new G4MultiFunctionalDetector(“myCellScorer”);//起名字，实例化多功能探测器

myCellLog->SetSensitiveDetector(myScorer);//attach to volume

G4VPrimitiveScorer* totalSurfFlux = new G4PSFlatSurfaceFlux(“TotalSurfFlux”);// 实例化一个功能
myScorer->RegisterPrimitive(totalSurfFlux);//注册功能
```

retrieve information

写在 EventAction 的 endofevent
1. 得到敏感探测器的 id，获取信息

```cpp
G4int collID = G4SDManager::GetSDMpointer()->GetCollectionID("myCellScorer/TotalSurfFlux");Get ID for the collection (given  the name)
```
2. 得到所有hit collection 的所有数据

```cpp
G4HCofThisEvent* HCE = event->GetHCofThisEvent(); //Get all HC available in this event
G4THitsMap<G4double>* evtMap = static_cast<G4THitsMap<G4double>*> (HCE->GetHC(collID));// Get the HC with the given ID (need a cast)
```

3. 读出 hit collection 的数据

```cpp
for (auto pair : *(evtMap->GetMap())) {
	G4double flux = *(pair.second);
	G4int copyNumber = *(pair.first);
	}
```

### 定义自己的敏感探测器

|Concrete class | Base class
-------|-----------|---------
Sensitive Detector | MySensitiveDetector| G4VSensitiveDetector 
Hit | myHit|G4VHit

`hits collection` 的指针为 `G4THitsCollection<MyHit*>`

#### G4VHit
Two virtual methods
- Draw()
- Print()

A “Hit” is like a “container”, a empty box which will store the information retrieved step by step.

The Hit concrete class (derived by G4VHit) must be written by the user: the user must decide *which variables* and/or information the hit should store and when store them

```cpp
class MyHit: public G4VHit{
public:
	MyHit();
	virtual ~MyHit();
	//决定获取沉积能量的信息
	inline void SetEnergyDeposit(G4double energy){energyDeposit = energy;}
	inline G4double GetEnergyDeposit(){return energyDeposit;}
	
private:
	G4double energyDeposit;
}
```

Hits objects can be filled with information in the ProcessHits() method of the SD concrete user class

#### SD
G4VSensitiveDetector
- Initialize()
- ProcessHits() pure virtual method
 - invoked for each step if step starts in logical volume having the SD attached
- EndOfEvent()

```cpp
class MySensitiveDetector : public G4VSensitiveDetector
{
public:
    MySensitiveDetector(G4String name);// 用以在敏感探测器管理类注册和获取 collection id
	virtual ~MySensitiveDetector()
    void Initialize(G4HCofThisEvent*) override;
    G4bool ProcessHits(G4Step* aStep, G4TouchableHistory* ROhist) override;
private:
    MyHitsCollection* hitsCollection { nullptr };
    G4int CollectionID { -1 };
};

MySensitiveDetector::MySensitiveDetector(G4String detectorUniqueName):
G4VSensitiveDetector(detectorUniquename),collectionID(-1){
collectionName.insert("collection_name");
}

class G4VSensitiveDetector{
protected:
	G4CollectionNameVector collectionName;
	//this protected name vector must be filled in
	// the constructor of the concrete class for registering 
	// names of hits collection

    G4String SensitiveDetectorName; // detector name 在 constructor 赋值
};
```

- Initialize()


Construct all hits collections and insert them in the G4HCofThisEvent object, which is passed as argument to Initialize()

1. 得到该敏感探测器的 id
2. 添加 hitcollection


id 管理类才知道，敏感探测器不知道用户注册的顺序，所以首先要得到id ，这样才将自己的 hit collection 注册给管理类，先前写 hit 只是在写保存什么样的数据，管理类并没有开辟一个空间给它存数据

```cpp
void MySensitiveDetector::Initialize(G4HCofThisEvent* HCE){
if(collectionID<0)
	collectionID=G4SDManager::GetSDMpointer()->GetCollectionID(GetName() + "/" + collectionName[0]);
hitsCollection = new MyHitsCollection(SensitiveDetectorName,collectionName[0]);
}
```

- ProcessHits()

The main mandate of this method is to generate hit(s) or to accumulate data to existing hit objects, by using information from the current step

1. create hit
2. fill hit
3. insert in the collection

```
G4bool MysensitiveDetector::ProcessHit(G4Step* step, G4TouchableHistory* ROhist){
MyHit* hit = new Myhit();

G4double energyDeposit = step->GetTotalEnergyDeposit();
hit->SetEnergyDeposit(energyDeposit);

hitsCollection->insert(hit);
return true;
}
```

- 保存数据

保存数据和先前一样，在 EndofEventAction() 下写，得到 id , 通过 ID 得到hit collection， 再得到各个hit，通过hit的get方法得到数据，保存

[传送门]({{ site.url }}/2017/09/11/geant4-数据保存/)